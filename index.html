<!DOCTYPE html>
<html>
    <head>
        <title>
            C compiler tutorial
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100&family=Roboto:wght@300&display=swap">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100&family=Raleway:wght@300&family=Roboto:wght@300&display=swap">
        <link rel="stylesheet" href="styles.css">
    </head>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CBJWK8BNDP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-CBJWK8BNDP');
    </script>
    <body>
        <div id="hor-scroll-bar" style="display:block;position:fixed;top:0;left:0;
        background-color:rgb(5, 241, 5);height:1vh;"></div>
        <div id="content-navigation-anim" style="display:none">
            <div id="content-navigation-body">
                <p style="font-family:Inter,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-size:3em">
                    Contents
                </p>
                <ul style="font-size:2em;font-weight:normal;list-style:none;line-height:2em;
                font-family:Inter,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif">
                    <li class="make-bold-0" style="font-weight:bold">Introduction</li>
                    <li class="make-bold-1">Lexing</li>
                </ul>
            </div>
        </div>
        <div id="nav-icon" onclick="toggleContentBar()">
            <div class="bar bar1"></div>
            <div class="bar bar2"></div>
            <div class="bar bar3"></div>
        </div>
        <div class="image-block" id="logo-image" style="width:100%;text-align:center">
            <img src="assets/logo.png">
        </div>
        <div style="height:3rem"></div>
        <h1 id="header-content-0">Writing a C compiler from scratch</h1>
        <h1 id="header-content-1" style="display:none">Writing C compiler - Part 1, Lexing</h1>
        <div class="article-block">
            <p><b>Contents</b></p>
            <ul>
                <li class="make-bold-0" id="option-0" style="color:rgb(0, 119, 255);font-weight:bold;" onclick="chooseOption(0)">Introduction</li>
                <li class="make-bold-1" id="option-1" onclick="chooseOption(1)">Lexing</li>
                <!-- <li id="option-2" onclick="chooseOption(2)">Parsing</li>
                <li id="option-3" onclick="chooseOption(3)">Evaluation</li> -->
            </ul>
        </div>
        <div class="wrapper" id="content-0">
            <p>
                Writing a compiler can be challenging and fun. It's fun if you simply take it up as an exercise to learn about lexing,
                parsing and code generation. Not so fun if you try to implement an actual general purpose language in all it's glory.
            </p>
            <p>
                Check out this repo to see how I made a simple C compiler<br>
            <a href="https://github.com/RohitRTdev/simc">https://github.com/RohitRTdev/simc</a>
            </p>
            <p>
                To keep this process enjoyable, we will only be building a C compiler that supports a subset of the language features.
                For more info on the exact features implemented, please visit the repo. With that in mind, let's get onto it.
            </p>
            <p>
                To write any compiler, we need to do 3 main tasks
            </p>
            <ol>
                <li>Lexing</li>
                <li>Parsing</li>
                <li>Evaluation and code-generation</li>
            </ol>
            <p>
                To understand these 3 processes, let's first see what we are even trying to do. Whenever faced with a complex task, take a simple example first and see how the solution looks for that case alone, and then work on generalizing it.
                <br><br>Let's consider the code:
            </p>
<pre>
    <span style="color:rebeccapurple;"><b>int </b></span>a = b + c * d++ - *m;
</pre>
            <div class="code-block">
            </div>
            <p>
                How do we generate the code for this above statement. Before even answering this question,
                we need to first ask ourselves what architecture do we want to generate code for.
                I have decided to use the famous x64 / AMD64 architecture since it is the most widely used one in consumer PC's and laptops.
            </p>
            <p>
                Now that we've decided the arch, let's see how the assembly for the code snippet above looks like.
            </p>
<pre>
    <span  style="color: rgb(136, 136, 136);">//Anything that starts with '//' is a comment</span>
    <span  style="color: rgb(136, 136, 136);">//x64 assembly in att syntax</span>
    <span  style="color: rgb(136, 136, 136);">//d++</span>
    movl -<span  style="color: rgb(136, 0, 0);">12</span>(<span  style="color: rgb(57, 115, 0);">%rbp</span>), <span  style="color: rgb(57, 115, 0);">%ebx</span> <span  style="color: rgb(136, 136, 136);">//Load 'd'(assume it's stored at stack location rbp-12)</span>
    addl <span  style="color: rgb(136, 0, 0);">1</span>, -<span  style="color: rgb(136, 0, 0);">12</span>(<span  style="color: rgb(57, 115, 0);">%rbp</span>) <span  style="color: rgb(136, 136, 136);">//Increment 'd'</span>
    <span  style="color: rgb(136, 136, 136);">//c * d++</span>
    movl -<span  style="color: rgb(136, 0, 0);">8</span>(<span  style="color: rgb(57, 115, 0);">%rbp</span>), <span  style="color: rgb(57, 115, 0);">%eax</span> <span  style="color: rgb(136, 136, 136);">//Load 'c'</span>
    imull <span  style="color: rgb(57, 115, 0);">%ebx</span>, <span  style="color: rgb(57, 115, 0);">%eax</span> <span  style="color: rgb(136, 136, 136);">// Signed multiply c * d++, now res0 = c * d++</span>
    <span  style="color: rgb(136, 136, 136);">//*m</span>
    movq -<span  style="color: rgb(136, 0, 0);">24</span>(<span  style="color: rgb(57, 115, 0);">%rbp</span>), <span  style="color: rgb(57, 115, 0);">%rbx</span> <span  style="color: rgb(136, 136, 136);">//Load 'm'(We're loading into rbx since pointer is 8 bytes)</span>
    movl (<span  style="color: rgb(57, 115, 0);">%rbx</span>), <span  style="color: rgb(57, 115, 0);">%ebx</span> <span  style="color: rgb(136, 136, 136);">//Dereference pointer 'm', so res1 = *m</span>
    <span  style="color: rgb(136, 136, 136);">//sub res1 from res0</span>
    subl <span  style="color: rgb(57, 115, 0);">%eax</span>, <span  style="color: rgb(57, 115, 0);">%ebx</span> <span  style="color: rgb(136, 136, 136);">// Now res2 = res0 - res1</span>
    <span  style="color: rgb(136, 136, 136);">//b + res2</span>
    addl (<span  style="color: rgb(57, 115, 0);">%rbp</span>), <span  style="color: rgb(57, 115, 0);">%ebx</span> <span  style="color: rgb(136, 136, 136);">// This gives us the final result</span>
    <span  style="color: rgb(136, 136, 136);">//a = final_result</span>
    movl <span  style="color: rgb(57, 115, 0);">%ebx</span>, -<span  style="color: rgb(136, 0, 0);">28</span>(<span  style="color: rgb(57, 115, 0);">%rbp</span>) <span  style="color: rgb(136, 136, 136);">//Store final result at 'a'</span>
</pre>
            <p>
                Variables b, c and d are assumed to be of type int and m is assumed to be of type int* .
            </p>
            <p>
                Notice a few things here. First the variable's location. In C, variables are mostly stored in the stack, and it grows downwards in x64 arch. This is not the case always tho(variables could also be located in static memory or heap). Also notice the offsets at which the variables are stored. They are allocated in such a way that all the variables are aligned on their natural boundary( int variables are aligned on 4 byte boundaries and pointers are aligned on 8 byte boundaries).
            </p>
        </div>
        <div class="wrapper" id="content-1" style="display:none">
            <p>
                Now that we've generated the code, let's see how to make our compiler do this. To perform this, what should we do first?
            </p>
            <p>
                The compiler will only be given an input file, which contains a huge string.
                We need to make sense of this string, i.e convert it into symbols that the C language understands.
                This is where step 1 comes in Lexing. In this step, we break the input set of characters into tokens that our compiler understands.
            </p>
            <p>
                After lexing, we should generate a list of tokens from our input string
            </p>
<pre>
    <span class="token-highlight">token1:</span> Type:<span class="type-highlight">keyword</span>, symbol:<span class="symbol-highlight">int</span>
    <span class="token-highlight">token2:</span> Type:<span class="type-highlight">Identifier</span>, symbol:<span class="symbol-highlight">'a'</span>
    <span class="token-highlight">token3:</span> Type:<span class="type-highlight">Operator</span>, symbol:<span class="symbol-highlight">'='</span>
    <span class="token-highlight">token4:</span> Type:<span class="type-highlight">Identifier</span>, symbol:<span class="symbol-highlight">'b'</span>
    <span class="token-highlight">token5:</span> Type:<span class="type-highlight">Operator</span>, symbol:<span class="symbol-highlight">'+'</span>
    <span class="token-highlight">token6:</span> Type:<span class="type-highlight">Identifier</span>, symbol:<span class="symbol-highlight">'c'</span>
    <span class="token-highlight">token7:</span> Type:<span class="type-highlight">Operator</span>, symbol:<span class="symbol-highlight">'*'</span>
    <span class="token-highlight">token8:</span> Type:<span class="type-highlight">Identifier</span>, symbol:<span class="symbol-highlight">'d'</span>
    <span class="token-highlight">token9:</span> Type:<span class="type-highlight">Operator</span>, symbol:<span class="symbol-highlight">'++'</span>
    <span class="token-highlight">token10:</span> Type:<span class="type-highlight">Operator</span>, symbol:<span class="symbol-highlight">'-'</span>
    <span class="token-highlight">token11:</span> Type:<span class="type-highlight">Operator</span>, symbol:<span class="symbol-highlight">'*</span>
    <span class="token-highlight">token12:</span> Type:<span class="type-highlight">Identifier</span>, symbol:<span class="symbol-highlight">'m'</span>
</pre>
        <p>All of the lexer code is included in the lexer.cpp file under src/simcc. 
            It simply iterates through the list of characters and tries to generate a <b>token object</b>. 
            This object is defined in token.h header file under include/compiler folder.
        </p>

        </div>
        <div class="navigator">
            <hr style="border-color:grey">
            <div class="add-span-margin">
                <span onclick="choosePrevOption()" id="prev-tab" style="display:none">Prev</span>
                <span onclick="chooseNextOption()" id="next-tab">Next</span>
            </div>
        </div>
        <div class="contact-info"; style="display:flex;position:relative;bottom:0;left:0;
            background-color:grey;color:lightgray;width:100%;min-height:10rem;
            text-align:center; justify-content: center;align-items:center;font-family:Raleway,'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif">
            <p style="margin:0;font-weight:bold;font-size:1.8em;">Will soon add some contact information here</p>
        </div>
    <script>
        var existingOption = 0;

        let scroll = document.getElementById("hor-scroll-bar");
        let body = document.querySelector("body");
        body.onscroll = (event) => {
            scroll.style.width = 100 * (window.scrollY / (body.scrollHeight - window.innerHeight)) + "%";
        };

        function setNavTab() {
            let prevTab = document.getElementById("prev-tab");
            let nextTab = document.getElementById("next-tab");

            if(existingOption == 0) {
                prevTab.style.display = "none";
            }
            else {
                prevTab.style.display = "";
            }

            if(existingOption == 1) {
                nextTab.style.display = "none";
            }
            else {
                nextTab.style.display = "";
            }
        }

        function chooseOption(option) {
            if(option == existingOption)
                return;

            //Change the option highlight
            let make_bold = document.querySelector(".make-bold-"+existingOption);
            let opt = document.getElementById("option-"+existingOption);
            make_bold.style.fontWeight = "normal";
            opt.style.fontWeight = "normal";
            opt.style.color = "";

            let make_bold_new = document.querySelector(".make-bold-"+option);
            let newOpt = document.getElementById("option-"+option);
            make_bold_new.style.fontWeight = "bold";
            newOpt.style.fontWeight = "bold";
            newOpt.style.color = "rgb(0, 119, 255)";


            //Change the content
            opt = document.getElementById("content-"+existingOption);
            opt.style.display = "none";
            newOpt = document.getElementById("content-"+option);
            newOpt.style.display = "";
            opt = document.getElementById("header-content-"+existingOption);
            opt.style.display = "none";
            newOpt = document.getElementById("header-content-"+option);
            newOpt.style.display = "";

            existingOption = option;
            window.scroll(0,0);
            setNavTab();
        }

        function chooseNextOption() {
            var option = existingOption + 1;
            chooseOption(option);
        }

        function choosePrevOption() {
            var option = existingOption - 1;
            chooseOption(option);
        }


        var isContentDisplayed = false;

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function toggleContentBar() {
            //Display the contents bar
            let anim = document.getElementById("content-navigation-anim");
            if(isContentDisplayed) {
                anim.style.opacity = "0";
                await sleep(100);
                anim.style.display = "none";
                body.style.overflow = "auto";
            }
            else {
                window.scroll(0,0);
                anim.style.display = "block";
                await sleep(100);
                anim.style.opacity = "0.8";
                body.style.overflow = "hidden";
            }

            //Transform the menu icon
            let menuIcon = document.getElementById("nav-icon");
            menuIcon.classList.toggle("animate-bar");

            //Shift the menu icon
            let img = document.getElementById("logo-image");

            if(isContentDisplayed) {
                //Hide img first
                menuIcon.style.right = "95%";
                img.style.visibility = "visible";
                await sleep(500);
                menuIcon.style.left = "0";
                menuIcon.style.display = "";
            }
            else {
                menuIcon.style.right = "0";
                menuIcon.style.left = "unset";
                img.style.visibility = "hidden";
                menuIcon.style.display = "block";
            }

            isContentDisplayed = !isContentDisplayed;

        }
    </script>
    </body>
</html>